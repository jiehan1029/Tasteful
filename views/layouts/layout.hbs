<!DOCTYPE html>
<html lang="en">
<head>
<title>Tasteful - Make.Enjoy.Share</title>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">
<style>
body{ 
	box-sizing: border-box; 
}
footer{
	color:lightgrey;
	margin-top:50px;
	text-align:center;
	font-size:0.6rem;
}
header{
	background-image: url('http://res.cloudinary.com/rollercoaster/image/upload/q_51/v1527740715/254237-P48QYH-494.jpg');
	background-repeat: no-repeat;
	background-size: cover;
}
</style>
</head>
<body>
	<header class='container-fluid header-template-container'>
	<script id="header-template" type="text/x-handlebars-templates">
		<nav class="navbar navbar-expand navbar-light bg-light col-md-10 offset-md-1">
		  	<div class="collapse navbar-collapse">
			    <ul class="navbar-nav ml-auto">
				    \{{#if userLoggedIn}}
				    <li class="nav-item">
				        <p class="nav-link">Welcome! \{{userLoggedIn}}</p>
			      	</li>
			      	<li class="nav-item">
			        	<a class="nav-link recipebookLink" href="/recipe-books">My recipebook</a>
			      	</li>
			      	<li class="nav-item">
			      		<a class="nav-link logoutLink" href="#">Logout</a>
			  	  	</li>
			  	  	\{{else}}
			      	<li class="nav-item loginToggle">
			     		<a class="nav-link loginLink" href="#">
			     		Login/Signup</a>
			    	</li>
				    \{{/if}}
			    </ul>
		  	</div>
		</nav>
		<h1 class='pageHeader h1 text-center'><a href="/">Tasteful</a></h1>
		<p class='lead text-center'>Make. Enjoy. Share.</p>
	</script>
	</header>

	<main class='container-fluid'>
	</main>

		<div id='login-modal-container' hidden>
			<h1 class="h5">Login/Signup to explore more</h1>
		    <form class="login-form" onsubmit={return false;}>
				<fieldset>
				<label for="loginUsername">Username</label>
			 	<input id="loginUsername" class='login-username' type="text" class="form-control" required>
			 	<label for="loginPassword">Password</label>
			 	<input id="loginPassword" class='login-password' type="text" class="form-control" required>
			 	</fieldset>
			 	<button type="submit" class="loginBtn btn btn-primary">Log in</button>
			 	<button class="btn signupBtn">Sign up</button>
			</form>			
		</div>	

	<footer>
		<hr>
		<p>jiehan1029@gmail.com May 2018</p>
	</footer>


	<script
  src="https://code.jquery.com/jquery-3.3.1.min.js"
  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
  crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js" integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ" crossorigin="anonymous"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js" integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm" crossorigin="anonymous"></script>
	<script src='https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.11/handlebars.min.js'></script>

	<script type="text/javascript">

		/*********** render header *************/
		let headerTemplate=Handlebars.compile($('#header-template').html());
		$(loadHeader);
		// display header navbar based on user login status
		function loadHeader(){
			let userLoggedIn=Cookies.get('username')===undefined ? false:Cookies.get('username');
			let hbsObj={userLoggedIn:userLoggedIn};
			$('.header-template-container').html(headerTemplate(hbsObj))
		}

		/*********** Login/Signup modal display *************/
		$('body').on('click','.loginLink', function(e){
			e.preventDefault();
			e.stopPropagation();
			// clear any remainders
			$('.login-form').find('.remainder').remove();
			// show div
			$('#login-modal-container').attr({hidden:false});
			$.fancybox.open({
				src:'#login-modal-container',
				type:'inline',
				opts:{
					afterShow:function(instance,current){
						console.info('show login/signup in modal!')
					}
				}
			});		
			});

		/************** enable login/signup/logout functionality **************/
		// enable login
		$('body').on('click','.loginBtn', function(e){
			e.stopPropagation();
			e.preventDefault();
			// call server to log in
			const options={
				url:'/auth/login',
				type:'POST',
				contentType: "application/json; charset=utf-8",
				dataType:'json',
				data:JSON.stringify({
					"username":$('#loginUsername').val(),
					"password":$('#loginPassword').val()
				})
			};

			$.ajax(options)
			.then(function(data){
				console.log('User login succeeded');
				loadHeader();
				console.log(data);
				sessionStorage.setItem('userBooks', JSON.stringify(data));
				$.fancybox.close();
			})
			.catch(err=>{
				console.log(err);
				if(err.status===401){
					$('.login-form').append(`<p class='.remainder'>Username or password is not correct!</p>`);
				}
			})
		});

		// enable signup
		$('body').on('click','.signupBtn', function(e){
			e.stopPropagation();
			e.preventDefault();
			// call server to create account
			const options={
				url:'/users',
				type:'POST',
				contentType: "application/json; charset=utf-8",
				dataType:'json',
				data:JSON.stringify({
					"username":$('#loginUsername').val(),
					"password":$('#loginPassword').val()
				})
			};
			$.ajax(options)
			.then(function(data){
				console.log('User registration succeeded');
				return data;
			})
			.then(function(data){
				// login on server side
				const options2={
					url:'/auth/login',
					type:'POST',
					contentType: "application/json; charset=utf-8",
					dataType:'json',
					data:JSON.stringify({
						"username":data.username,
						"password":$('#loginPassword').val()
					})						
				};

				$.ajax(options2)
				.then(function(dataFrLogin){
					console.log('automatic login succeeded');
					loadHeader();
					console.log(dataFrLogin);
					sessionStorage.setItem('userBooks', JSON.stringify(dataFrLogin));
					// close modal
					$.fancybox.close();
				})
				.catch(err=>{
					console.log(err);
					$('.login-form').append(`<p class='.remainder'>Internal server error!</p>`);
				})
			})
			.catch(err=>{
				console.log(err);
				$('.login-form').append(`<p class='.remainder'>Internal server error!</p>`);
			});
		});

		// enable logout 
		$('body').on('click','.logoutLink', function(e){
			e.preventDefault();
			e.stopPropagation();
			const options={
				url:'/auth/logout',
				method:'GET'
			};
			$.ajax(options)
				.then((res)=>{
					console.log(res.message);
					loadHeader();
					sessionStorage.removeItem('userBooks');
				})
				.catch(err=>{
					console.log(err);
				});
		});

	</script>	

{{{block scripts}}}

</body>
</html>

